{% extends "base.html" %}

{% block title %}Daten löschen - Marketing Agent{% endblock %}

{% block content %}
<div class="container py-5">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <!-- Header -->
            <div class="text-center mb-5">
                <i class="bi bi-shield-exclamation text-danger" style="font-size: 4rem;"></i>
                <h1 class="mt-3">Datenlöschung</h1>
                <p class="lead text-muted">Verwalten Sie Ihre persönlichen Daten</p>
            </div>

            <!-- Information Card -->
            <div class="card border-info mb-4">
                <div class="card-body">
                    <h5 class="card-title">
                        <i class="bi bi-info-circle text-info"></i>
                        Ihre Rechte gemäß DSGVO
                    </h5>
                    <p class="card-text">
                        Sie haben jederzeit das Recht, Ihre personenbezogenen Daten zu löschen oder einzuschränken. 
                        Diese Seite bietet Ihnen folgende Möglichkeiten:
                    </p>
                    <ul>
                        <li><strong>Datenauskunft:</strong> Übersicht Ihrer gespeicherten Daten</li>
                        <li><strong>Teillöschung:</strong> Löschen einzelner Datenkategorien</li>
                        <li><strong>Komplettlöschung:</strong> Vollständige Löschung Ihres Kontos</li>
                        <li><strong>Datenexport:</strong> Download Ihrer Daten (JSON-Format)</li>
                    </ul>
                </div>
            </div>

            {% if current_user.is_authenticated %}
            <!-- Authenticated User Options -->
            <div class="card mb-4">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">
                        <i class="bi bi-person-circle"></i>
                        Ihr Konto: {{ current_user.email }}
                    </h5>
                </div>
                <div class="card-body">
                    <!-- Data Overview -->
                    <h6 class="mb-3">Gespeicherte Daten:</h6>
                    <div class="table-responsive">
                        <table class="table table-sm">
                            <tbody>
                                <tr>
                                    <td><i class="bi bi-envelope"></i> E-Mail</td>
                                    <td>{{ current_user.email }}</td>
                                </tr>
                                <tr>
                                    <td><i class="bi bi-calendar"></i> Registriert seit</td>
                                    <td>{{ current_user.created_at.strftime('%d.%m.%Y') if current_user.created_at else 'N/A' }}</td>
                                </tr>
                                <tr>
                                    <td><i class="bi bi-key"></i> API-Keys</td>
                                    <td>
                                        {% if current_user.openai_api_key %}OpenAI{% endif %}
                                        {% if current_user.telegram_bot_token %}, Telegram{% endif %}
                                        {% if current_user.linkedin_access_token %}, LinkedIn{% endif %}
                                        {% if current_user.meta_access_token %}, Meta{% endif %}
                                    </td>
                                </tr>
                                <tr>
                                    <td><i class="bi bi-calendar-event"></i> Zeitpläne</td>
                                    <td>{{ schedule_count }} aktiv</td>
                                </tr>
                                <tr>
                                    <td><i class="bi bi-file-earmark"></i> Dateien</td>
                                    <td>{{ file_count }} hochgeladen</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <hr>

                    <!-- Action Buttons -->
                    <div class="d-grid gap-3">
                        <!-- Export Data -->
                        <a href="{{ url_for('dashboard.export_user_data') }}" class="btn btn-outline-primary">
                            <i class="bi bi-download"></i>
                            Daten exportieren (JSON)
                        </a>

                        <!-- Delete API Keys -->
                        <button type="button" class="btn btn-outline-warning" data-bs-toggle="modal" data-bs-target="#deleteApiKeysModal">
                            <i class="bi bi-key"></i>
                            API-Keys löschen
                        </button>

                        <!-- Delete Content -->
                        <button type="button" class="btn btn-outline-warning" data-bs-toggle="modal" data-bs-target="#deleteContentModal">
                            <i class="bi bi-file-earmark-x"></i>
                            Zeitpläne und Dateien löschen
                        </button>

                        <!-- Delete Account -->
                        <button type="button" class="btn btn-danger" data-bs-toggle="modal" data-bs-target="#deleteAccountModal">
                            <i class="bi bi-trash"></i>
                            Konto vollständig löschen
                        </button>
                    </div>
                </div>
            </div>

            {% else %}
            <!-- Not Authenticated -->
            <div class="alert alert-warning">
                <h5 class="alert-heading">
                    <i class="bi bi-exclamation-triangle"></i>
                    Nicht angemeldet
                </h5>
                <p>Um Ihre Daten zu löschen, müssen Sie sich zunächst anmelden.</p>
                <hr>
                <a href="{{ url_for('auth.login') }}" class="btn btn-warning">
                    <i class="bi bi-box-arrow-in-right"></i>
                    Zur Anmeldung
                </a>
            </div>

            <!-- External User Data Deletion Request -->
            <div class="card mt-4">
                <div class="card-header">
                    <h5 class="mb-0">Datenlöschung ohne Login</h5>
                </div>
                <div class="card-body">
                    <p>Falls Sie keinen Zugriff mehr auf Ihr Konto haben, können Sie eine Datenlöschung per E-Mail beantragen:</p>
                    <a href="mailto:support@andriit.de?subject=Datenlöschung Marketing Agent&body=Bitte löschen Sie alle meine Daten für die E-Mail-Adresse: [IHRE EMAIL]" class="btn btn-outline-primary">
                        <i class="bi bi-envelope"></i>
                        Löschung per E-Mail beantragen
                    </a>
                </div>
            </div>
            {% endif %}

            <!-- Meta/Facebook User Data Deletion -->
            <div class="card mt-4 border-primary">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">
                        <i class="bi bi-facebook"></i>
                        Meta/Facebook App-Daten
                    </h5>
                </div>
                <div class="card-body">
                    <p>Wenn Sie sich über Facebook/Meta angemeldet haben und Ihre App-Daten löschen möchten:</p>
                    <ol>
                        <li>Melden Sie sich bei Facebook an</li>
                        <li>Gehen Sie zu <strong>Einstellungen & Privatsphäre</strong> → <strong>Einstellungen</strong></li>
                        <li>Wählen Sie <strong>Apps und Websites</strong></li>
                        <li>Suchen Sie <strong>Marketing Agent</strong></li>
                        <li>Klicken Sie auf <strong>Entfernen</strong></li>
                    </ol>
                    <p class="mb-0">
                        <a href="https://www.facebook.com/settings?tab=applications" target="_blank" class="btn btn-outline-primary">
                            <i class="bi bi-box-arrow-up-right"></i>
                            Zu Facebook App-Einstellungen
                        </a>
                    </p>
                </div>
            </div>

            <!-- Contact Info -->
            <div class="alert alert-info mt-4">
                <h6 class="alert-heading">
                    <i class="bi bi-question-circle"></i>
                    Fragen zur Datenlöschung?
                </h6>
                <p class="mb-0">
                    Kontaktieren Sie uns: <a href="mailto:support@andriit.de">support@andriit.de</a>
                </p>
            </div>

            <!-- Back to Home -->
            <div class="text-center mt-4">
                <a href="{{ url_for('public.landing') }}" class="btn btn-link">
                    <i class="bi bi-arrow-left"></i>
                    Zurück zur Startseite
                </a>
            </div>
        </div>
    </div>
</div>

<!-- Modal: Delete API Keys -->
<div class="modal fade" id="deleteApiKeysModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-warning">
                <h5 class="modal-title">
                    <i class="bi bi-key"></i>
                    API-Keys löschen
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Möchten Sie alle gespeicherten API-Keys löschen?</p>
                <p class="text-muted small">Dies betrifft:</p>
                <ul class="small">
                    <li>OpenAI API-Key</li>
                    <li>Telegram Bot Token</li>
                    <li>LinkedIn Access Token</li>
                    <li>Meta (Facebook/Instagram) Access Token</li>
                </ul>
                <div class="alert alert-warning">
                    <i class="bi bi-exclamation-triangle"></i>
                    <strong>Hinweis:</strong> Sie müssen diese Keys neu eingeben, um die Dienste wieder nutzen zu können.
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Abbrechen</button>
                <form action="{{ url_for('dashboard.delete_api_keys') }}" method="POST" class="d-inline">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <button type="submit" class="btn btn-warning">
                        <i class="bi bi-trash"></i>
                        API-Keys löschen
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Modal: Delete Content -->
<div class="modal fade" id="deleteContentModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-warning">
                <h5 class="modal-title">
                    <i class="bi bi-file-earmark-x"></i>
                    Zeitpläne und Dateien löschen
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Möchten Sie alle Zeitpläne und hochgeladenen Dateien löschen?</p>
                <ul class="small">
                    <li>{{ schedule_count }} Zeitpläne</li>
                    <li>{{ file_count }} Dateien</li>
                </ul>
                <div class="alert alert-warning">
                    <i class="bi bi-exclamation-triangle"></i>
                    <strong>Hinweis:</strong> Diese Aktion kann nicht rückgängig gemacht werden!
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Abbrechen</button>
                <form action="{{ url_for('dashboard.delete_user_content') }}" method="POST" class="d-inline">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <button type="submit" class="btn btn-warning">
                        <i class="bi bi-trash"></i>
                        Inhalt löschen
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Modal: Delete Account -->
<div class="modal fade" id="deleteAccountModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title">
                    <i class="bi bi-exclamation-triangle"></i>
                    Konto löschen
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p><strong>Achtung!</strong> Diese Aktion löscht unwiderruflich:</p>
                <ul>
                    <li>Ihr Benutzerkonto</li>
                    <li>Alle API-Keys</li>
                    <li>Alle Zeitpläne</li>
                    <li>Alle hochgeladenen Dateien</li>
                    <li>Alle Abonnements</li>
                </ul>
                <div class="alert alert-danger">
                    <i class="bi bi-exclamation-triangle"></i>
                    <strong>Diese Aktion kann NICHT rückgängig gemacht werden!</strong>
                </div>
                <p class="mb-0">Bitte geben Sie zur Bestätigung Ihre E-Mail-Adresse ein:</p>
                <form id="deleteAccountForm" action="{{ url_for('dashboard.delete_account') }}" method="POST">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <div class="mb-3 mt-3">
                        <input type="email" name="confirm_email" class="form-control" 
                               placeholder="{{ current_user.email if current_user.is_authenticated else 'ihre@email.de' }}" 
                               required>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Abbrechen</button>
                <button type="submit" form="deleteAccountForm" class="btn btn-danger">
                    <i class="bi bi-trash"></i>
                    Konto endgültig löschen
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}
