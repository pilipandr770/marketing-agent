{% extends "base.html" %}

{% block title %}Abonnement - Marketing SaaS{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-10">
        <h2><i class="bi bi-credit-card"></i> Abonnement verwalten</h2>
        
        <!-- Current Plan -->
        <div class="card mb-4">
            <div class="card-header">
                <h5><i class="bi bi-star"></i> Aktueller Plan</h5>
            </div>
            <div class="card-body">
                <div class="row align-items-center">
                    <div class="col-md-6">
                        <h4 class="text-primary">{{ current_user.plan.title() }} Plan</h4>
                        {% if current_user.plan_expires_at %}
                            <p class="text-muted">Verlängert am: {{ current_user.plan_expires_at.strftime('%d.%m.%Y') }}</p>
                        {% endif %}
                        {% if current_user.stripe_subscription_id %}
                            <span class="badge bg-success">Aktives Abonnement</span>
                        {% else %}
                            <span class="badge bg-secondary">Kostenloser Plan</span>
                        {% endif %}
                    </div>
                    <div class="col-md-6 text-md-end">
                        {% if current_user.stripe_customer_id and current_user.stripe_subscription_id %}
                            <a href="#" class="btn btn-outline-primary" onclick="openCustomerPortal()">
                                <i class="bi bi-gear"></i> Abonnement verwalten
                            </a>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Pricing Plans -->
        <div class="row mb-4">
            <div class="col-12">
                <h4><i class="bi bi-tags"></i> Verfügbare Tarife</h4>
            </div>
        </div>
        
        <div class="row">
            <!-- Free Plan -->
            <div class="col-md-3 mb-4">
                <div class="card h-100 {{ 'border-secondary' if current_user.plan == 'free' else '' }}">
                    {% if current_user.plan == 'free' %}
                        <div class="card-header bg-secondary text-white text-center">
                            <i class="bi bi-check-circle"></i> Aktueller Plan
                        </div>
                    {% endif %}
                    <div class="card-body text-center">
                        <h5 class="card-title">Kostenlos</h5>
                        <h2 class="text-muted">0€ <small>/Monat</small></h2>
                        <ul class="list-unstyled mt-3">
                            <li><i class="bi bi-check text-success"></i> 1 Zeitplan</li>
                            <li><i class="bi bi-check text-success"></i> 10 Posts/Monat</li>
                            <li><i class="bi bi-check text-success"></i> Telegram</li>
                            <li><i class="bi bi-x text-muted"></i> KI-Features</li>
                            <li><i class="bi bi-x text-muted"></i> Multi-Platform</li>
                        </ul>
                        {% if current_user.plan != 'free' %}
                            <button class="btn btn-outline-secondary w-100" disabled>
                                Aktuell nicht verfügbar
                            </button>
                        {% else %}
                            <button class="btn btn-secondary w-100" disabled>
                                Aktueller Plan
                            </button>
                        {% endif %}
                    </div>
                </div>
            </div>
            
            <!-- Basic Plan -->
            <div class="col-md-3 mb-4">
                <div class="card h-100 {{ 'border-primary' if current_user.plan == 'basic' else '' }}">
                    {% if current_user.plan == 'basic' %}
                        <div class="card-header bg-primary text-white text-center">
                            <i class="bi bi-check-circle"></i> Aktueller Plan
                        </div>
                    {% endif %}
                    <div class="card-body text-center">
                        <h5 class="card-title">Basic</h5>
                        <h2 class="text-primary">29€ <small>/Monat</small></h2>
                        <ul class="list-unstyled mt-3">
                            <li><i class="bi bi-check text-success"></i> 5 Zeitpläne</li>
                            <li><i class="bi bi-check text-success"></i> 100 Posts/Monat</li>
                            <li><i class="bi bi-check text-success"></i> Telegram + Facebook</li>
                            <li><i class="bi bi-check text-success"></i> KI-Content</li>
                            <li><i class="bi bi-check text-success"></i> Bild-Generierung</li>
                        </ul>
                        {% if current_user.plan == 'basic' %}
                            <button class="btn btn-primary w-100" disabled>
                                Aktueller Plan
                            </button>
                        {% else %}
                            <a href="{{ url_for('dashboard.subscribe', plan='basic') }}" class="btn btn-primary w-100">
                                Wählen
                            </a>
                        {% endif %}
                    </div>
                </div>
            </div>
            
            <!-- Pro Plan -->
            <div class="col-md-3 mb-4">
                <div class="card h-100 border-success {{ 'bg-light' if current_user.plan == 'pro' else '' }}">
                    <div class="card-header bg-success text-white text-center">
                        {% if current_user.plan == 'pro' %}
                            <i class="bi bi-check-circle"></i> Aktueller Plan
                        {% else %}
                            <i class="bi bi-star"></i> Beliebt
                        {% endif %}
                    </div>
                    <div class="card-body text-center">
                        <h5 class="card-title">Pro</h5>
                        <h2 class="text-success">79€ <small>/Monat</small></h2>
                        <ul class="list-unstyled mt-3">
                            <li><i class="bi bi-check text-success"></i> 20 Zeitpläne</li>
                            <li><i class="bi bi-check text-success"></i> 500 Posts/Monat</li>
                            <li><i class="bi bi-check text-success"></i> Alle Kanäle</li>
                            <li><i class="bi bi-check text-success"></i> Erweiterte KI</li>
                            <li><i class="bi bi-check text-success"></i> TTS + Videos</li>
                            <li><i class="bi bi-check text-success"></i> Priority Support</li>
                        </ul>
                        {% if current_user.plan == 'pro' %}
                            <button class="btn btn-success w-100" disabled>
                                Aktueller Plan
                            </button>
                        {% else %}
                            <a href="{{ url_for('dashboard.subscribe', plan='pro') }}" class="btn btn-success w-100">
                                Wählen
                            </a>
                        {% endif %}
                    </div>
                </div>
            </div>
            
            <!-- Enterprise Plan -->
            <div class="col-md-3 mb-4">
                <div class="card h-100 {{ 'border-warning' if current_user.plan == 'enterprise' else '' }}">
                    {% if current_user.plan == 'enterprise' %}
                        <div class="card-header bg-warning text-white text-center">
                            <i class="bi bi-check-circle"></i> Aktueller Plan
                        </div>
                    {% endif %}
                    <div class="card-body text-center">
                        <h5 class="card-title">Enterprise</h5>
                        <h2 class="text-warning">199€ <small>/Monat</small></h2>
                        <ul class="list-unstyled mt-3">
                            <li><i class="bi bi-check text-success"></i> Unbegrenzte Zeitpläne</li>
                            <li><i class="bi bi-check text-success"></i> Unbegrenzte Posts</li>
                            <li><i class="bi bi-check text-success"></i> Alle Features</li>
                            <li><i class="bi bi-check text-success"></i> White Label</li>
                            <li><i class="bi bi-check text-success"></i> API Zugang</li>
                            <li><i class="bi bi-check text-success"></i> Dedicated Support</li>
                        </ul>
                        {% if current_user.plan == 'enterprise' %}
                            <button class="btn btn-warning w-100" disabled>
                                Aktueller Plan
                            </button>
                        {% else %}
                            <a href="{{ url_for('dashboard.subscribe', plan='enterprise') }}" class="btn btn-warning w-100">
                                Wählen
                            </a>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Features Comparison -->
        <div class="card mt-5">
            <div class="card-header">
                <h5><i class="bi bi-table"></i> Feature-Vergleich</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>Feature</th>
                                <th>Kostenlos</th>
                                <th>Basic</th>
                                <th>Pro</th>
                                <th>Enterprise</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>Zeitpläne</td>
                                <td>1</td>
                                <td>5</td>
                                <td>20</td>
                                <td>Unbegrenzt</td>
                            </tr>
                            <tr>
                                <td>Posts pro Monat</td>
                                <td>10</td>
                                <td>100</td>
                                <td>500</td>
                                <td>Unbegrenzt</td>
                            </tr>
                            <tr>
                                <td>Telegram</td>
                                <td><i class="bi bi-check text-success"></i></td>
                                <td><i class="bi bi-check text-success"></i></td>
                                <td><i class="bi bi-check text-success"></i></td>
                                <td><i class="bi bi-check text-success"></i></td>
                            </tr>
                            <tr>
                                <td>Facebook & Instagram</td>
                                <td><i class="bi bi-x text-muted"></i></td>
                                <td><i class="bi bi-check text-success"></i></td>
                                <td><i class="bi bi-check text-success"></i></td>
                                <td><i class="bi bi-check text-success"></i></td>
                            </tr>
                            <tr>
                                <td>LinkedIn</td>
                                <td><i class="bi bi-x text-muted"></i></td>
                                <td><i class="bi bi-x text-muted"></i></td>
                                <td><i class="bi bi-check text-success"></i></td>
                                <td><i class="bi bi-check text-success"></i></td>
                            </tr>
                            <tr>
                                <td>KI Text-Generierung</td>
                                <td><i class="bi bi-x text-muted"></i></td>
                                <td><i class="bi bi-check text-success"></i></td>
                                <td><i class="bi bi-check text-success"></i></td>
                                <td><i class="bi bi-check text-success"></i></td>
                            </tr>
                            <tr>
                                <td>KI Bild-Generierung</td>
                                <td><i class="bi bi-x text-muted"></i></td>
                                <td><i class="bi bi-check text-success"></i></td>
                                <td><i class="bi bi-check text-success"></i></td>
                                <td><i class="bi bi-check text-success"></i></td>
                            </tr>
                            <tr>
                                <td>Voice/TTS</td>
                                <td><i class="bi bi-x text-muted"></i></td>
                                <td><i class="bi bi-x text-muted"></i></td>
                                <td><i class="bi bi-check text-success"></i></td>
                                <td><i class="bi bi-check text-success"></i></td>
                            </tr>
                            <tr>
                                <td>Priority Support</td>
                                <td><i class="bi bi-x text-muted"></i></td>
                                <td><i class="bi bi-x text-muted"></i></td>
                                <td><i class="bi bi-check text-success"></i></td>
                                <td><i class="bi bi-check text-success"></i></td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

{% if request.args.get('status') == 'success' %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Show success message
    const alert = document.createElement('div');
    alert.className = 'alert alert-success alert-dismissible fade show';
    alert.innerHTML = `
        <i class="bi bi-check-circle"></i> Abonnement erfolgreich aktiviert!
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    document.querySelector('main').prepend(alert);
});
</script>
{% endif %}

{% if current_user.stripe_customer_id %}
<script>
function openCustomerPortal() {
    // In production, create portal session via backend
    fetch('/billing/create-portal-session', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token() }}'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.url) {
            window.location.href = data.url;
        } else {
            alert('Fehler beim Öffnen des Kundenportals.');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Fehler beim Öffnen des Kundenportals.');
    });
}
</script>
{% endif %}
{% endblock %}